#!/usr/bin/env bash
# Copyright (C) 2022-2023 CachyOS team
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.

set -e

function retrieve_package() {
  local package_name
  package_name="${1}"

  local package_directory
  package_directory="${2}/${1}"

  local git_url
  git_url="https://gitlab.archlinux.org/archlinux/packaging/packages/${package_name}"

  mkdir -p "${package_directory}" || {
    echo "Failed to create directory ${package_directory}" >&2
    return 1
  }

  local http_status
  http_status=$(curl -s -o /dev/null -I -w "%{http_code}" "${git_url}")

  if [[ ${http_status} != '200' ]]; then
    local response
    response=$(curl -sf "https://aur.archlinux.org/rpc/?v=5&type=search&by=name&arg=${package_name}")

    if [[ $? -ne 0 ]] || [[ -z ${response} ]]; then
      echo "Failed to connect to AUR" >&2
      return 1
    fi

    local package_base
    package_base=$(jq -r '.results[0].PackageBase' <<< "${response}")

    if [[ -z ${package_base} ]]; then
      echo "Package not found" >&2
      return 1
    fi

    git_url="https://aur.archlinux.org/${package_base}.git"
  fi

  git clone "${git_url}" "${package_directory}" > /dev/null 2>&1

  if [[ $? -ne 0 ]]; then
    echo "Failed to clone package from ${git_url}" >&2
    return 1
  fi
}

if (( $# < 1 )); then
  echo "Usage: getpkg <package_name> [<destination_path>]" >&2
  exit 1
fi

if retrieve_package "${1}" "${2:-$(pwd)}"; then
  echo "Package retrieved successfully."
else
  echo "Failed to retrieve package."
fi
